# HTTP server redirect to HTTPS
server {
    listen 80;
#    listen [::]:80;
#    server_name wilmie.myhome-server.de;
    server_name rpi2 rpi2.fritz.box;
    # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.
    return 301 https://$host$request_uri;
}
 
# HTTPS server
#
server {
    listen 443;
#    listen 443 ssl http2;
#    listen [::]:443 ssl http2;
	server_name wilmie.myhome-server.de;
#    server_name rpi2 rpi2.fritz.box;

	root /sd_p2/web/www;
	index index.php;
        access_log /var/log/www_ssl_access.log;
        error_log /var/log/www_ssl_error.log;

	ssl on;
#        ssl_certificate /etc/nginx/ssl/wilmie.crt;
#        ssl_certificate_key /etc/nginx/ssl/wilmie.key;
        ssl_certificate /etc/letsencrypt/live/wilmie.myhome-server.de/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/wilmie.myhome-server.de/privkey.pem;
        ssl_trusted_certificate /etc/letsencrypt/live/wilmie.myhome-server.de/chain.pem;

	ssl_session_timeout 5m;
	ssl_protocols SSLv3 TLSv1;
	ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
	ssl_prefer_server_ciphers on;

	location / {
                try_files $uri $uri/ index.php /index.php;
#                try_files index.php /index.php;
                disable_symlinks off;
#                auth_basic "Login wilmie.de";
#                auth_basic_user_file /sd_p2/web/.user;
	}
#        location /a {
#                try_files $uri $uri/ index.php /index.php;
#                disable_symlinks off;
#                auth_basic "Login wilmie.de";
#                auth_basic_user_file /sd_p2/web/.user;
#        }
        location /fhem {
                proxy_buffering   off;
                auth_basic "Login FHEM";
                auth_basic_user_file /sd_p2/web/.admin;
                proxy_pass http://rpi2.fritz.box:8083;
        }
        location /fhem_m {
                proxy_buffering   off;
                auth_basic "Login FHEM";
                auth_basic_user_file /sd_p2/web/.admin;
                proxy_pass http://rpi2.fritz.box:8084;
        }
        location ~ \.(php)$ {
                fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
                include snippets/fastcgi-php.conf;
        }
        location /png {
                fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
                include snippets/fastcgi-php.conf;
        }
#        location ^~ /admin {
#                auth_basic "Login Adminbereich";
#                auth_basic_user_file /sd_p2/web/.admin;
#                location ~ \.(php)$ {
#                        fastcgi_pass unix:/var/run/php/php7.0-fpm.sock;
#                        include snippets/fastcgi-php.conf;
#                }
#        }
        location ^~ /webalizer {
                auth_basic "Login Adminbereich";
                auth_basic_user_file /sd_p2/web/.admin;
        }
        location /wiki {
                disable_symlinks off;
                index index.php;
        }
        location ~ /\.ht {
                deny all;
        }
#location /netz/ {
# disable_symlinks off;
#    client_body_temp_path /tmp;
#    dav_methods PUT DELETE MKCOL COPY MOVE;
#    dav_ext_methods PROPFIND OPTIONS;
#    create_full_put_path on;
#    dav_access user:r group:r;

#    auth_basic "Restricted access";

#    auth_basic_user_file /sd_p2/web/.user;
#  }
}

